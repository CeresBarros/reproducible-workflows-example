<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ceres Barros">
<meta name="dcterms.date" content="2023-07-14">

<title>Example of a reproducible workflow in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="global_files/libs/clipboard/clipboard.min.js"></script>
<script src="global_files/libs/quarto-html/quarto.js"></script>
<script src="global_files/libs/quarto-html/popper.min.js"></script>
<script src="global_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="global_files/libs/quarto-html/anchor.min.js"></script>
<link href="global_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="global_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="global_files/libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="global_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="global_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="global_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="global_files/libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<style>html{ scroll-behavior: smooth; }</style>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#the-workflow-at-a-glance" id="toc-the-workflow-at-a-glance" class="nav-link" data-scroll-target="#the-workflow-at-a-glance">The workflow at a glance</a></li>
  <li><a href="#step-by-step" id="toc-step-by-step" class="nav-link" data-scroll-target="#step-by-step">Step by step</a>
  <ul>
  <li><a href="#project-structure-and-dependencies" id="toc-project-structure-and-dependencies" class="nav-link" data-scroll-target="#project-structure-and-dependencies">Project structure and dependencies</a></li>
  <li><a href="#running-the-workflow" id="toc-running-the-workflow" class="nav-link" data-scroll-target="#running-the-workflow">Running the workflow</a>
  <ul class="collapse">
  <li><a href="#functions-options-and-study-area" id="toc-functions-options-and-study-area" class="nav-link" data-scroll-target="#functions-options-and-study-area">Functions, options and study area</a></li>
  <li><a href="#data-sourcing-and-preparation" id="toc-data-sourcing-and-preparation" class="nav-link" data-scroll-target="#data-sourcing-and-preparation">Data sourcing and preparation</a></li>
  <li><a href="#analytical-steps---model-fitting-validation-and-projections" id="toc-analytical-steps---model-fitting-validation-and-projections" class="nav-link" data-scroll-target="#analytical-steps---model-fitting-validation-and-projections">Analytical steps - model fitting, validation and projections</a></li>
  <li><a href="#outputs" id="toc-outputs" class="nav-link" data-scroll-target="#outputs">Outputs</a></li>
  <li><a href="#and-voilà" id="toc-and-voilà" class="nav-link" data-scroll-target="#and-voilà">And voilà!</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#a-note-on" id="toc-a-note-on" class="nav-link" data-scroll-target="#a-note-on">A note on…</a>
  <ul>
  <li><a href="#debugging" id="toc-debugging" class="nav-link" data-scroll-target="#debugging">Debugging</a></li>
  <li><a href="#caching" id="toc-caching" class="nav-link" data-scroll-target="#caching">Caching</a></li>
  <li><a href="#saving" id="toc-saving" class="nav-link" data-scroll-target="#saving">Saving</a></li>
  </ul></li>
  <li><a href="#acknowledgements" id="toc-acknowledgements" class="nav-link" data-scroll-target="#acknowledgements">Acknowledgements</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Example of a reproducible workflow in R</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Ceres Barros </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 14, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Repeatable, Reproducible, Reusable and Transparent (<span class="math inline">R^3</span>T) workflows are becoming more and more commonly used in academic and non-academic settings to ensure that analyses and their outputs can be verified and repeated by peers, stakeholders and even the public. As such, (<span class="math inline">R^3</span>T) promote trust within the scientific community and between scientists, stakeholders, end-users and the public. <span class="math inline">R^3</span>T are also fundamental for model benchmarking, conducting meta-analyses and facilitating building-on and improving current scientific methods, especially those involving statistical and non-statistical modelling.</p>
<p>In the ecological domain, <span class="math inline">R^3</span>T are gaining traction, but many of us struggle at the start, not knowing where to begin. This example will take you through setting up an <span class="math inline">R^3</span>T workflow for a common analysis in ecology, species distribution modelling.</p>
<p>The workflow has been kept as simple as possible, while following a few common guidelines that facilitate building <span class="math inline">R^3</span>T workflows:</p>
<ol type="1">
<li><p>Scripting;</p></li>
<li><p>Minimising no. software/languages used;</p></li>
<li><p>Modularising &amp; “functionising”;</p></li>
<li><p>Centralising the workflow in a single script;</p></li>
<li><p>Using a self-contained &amp; project-oriented workflow;</p></li>
<li><p>Using version control;</p></li>
<li><p>Using (minimal) integrated testing.</p></li>
</ol>
<p>It also relies on two important packages that enable reproducibility and speed up subsequent runs (i.e.&nbsp;re-runs) the workflow in the same machine:</p>
<ul>
<li><p><a href="https://require.predictiveecology.org/"><code>Require</code></a> <span class="citation" data-cites="Require">(<a href="#ref-Require" role="doc-biblioref">McIntire 2023</a>)</span> - for self-contained and reproducible <code>R</code> package installation;</p></li>
<li><p><a href="https://reproducible.predictiveecology.org/"><code>reproducible</code></a> <span class="citation" data-cites="reproducible">(<a href="#ref-reproducible" role="doc-biblioref">McIntire and Chubaty 2023</a>)</span> - for caching, establishing explicit links to raw data, common GIS operations, and more.</p></li>
</ul>
<p>However, please note that there are numerous other <code>R</code> packages (as well as other languages and types of software) that facilitate and support <span class="math inline">R^3</span>T workflows. This is simply an example using some of the tools that I use when building my workflows.</p>
</section>
<section id="the-workflow-at-a-glance" class="level2">
<h2 class="anchored" data-anchor-id="the-workflow-at-a-glance">The workflow at a glance</h2>
<p>In this example, I use a simple statistical framework to predict climate-driven range changes of white spruce (<em>Picea glauca</em>), a common tree species in Canada. It should, by no means, be interpreted as a good way to project changes in the <em>actual</em> distributions of white spruce, which will likely involve many more drivers and ecological processes than the ones included here.l</p>
<p>To keep the example simple, I focused on white spruce distribution changes within the province of British Columbia (BC) in response to variation in four bioclimatic predictors <span class="citation" data-cites="fick2017">(obtained from <a href="https://www.worldclim.org/data/bioclim.html" role="doc-biblioref">WorldClim</a>, <a href="#ref-fick2017" role="doc-biblioref">Fick and Hijmans 2017</a>)</span>:</p>
<ul>
<li><p>BIO1 - Annual Mean Temperature;</p></li>
<li><p>BIO4 - Temperature Seasonality;</p></li>
<li><p>BIO12 - Annual Precipitation;</p></li>
<li><p>BIO15 - Precipitation Seasonality.</p></li>
</ul>
<p>The baseline white spruce distribution for BC was obtained from the 2011 species % cover maps by <span class="citation" data-cites="beaudoin2014">Beaudoin et al. (<a href="#ref-beaudoin2014" role="doc-biblioref">2014</a>)</span>, freely available at the Canadian National Forest Inventory database. The baseline values for each bioclimatic variable corresponded to projections for the normal climate period of 1970-2010 (hereafter, 2010), while future values where obtained from projections for the periods 2021-2040 (2030), 2041-2060 (2050), 2061-2080 (2070) and 2081-2100 (2090), using the CanESM5 General Circulation Model and the SSP 585 emissions scenario.</p>
<p>In this workflow, I use a single random forest model <span class="citation" data-cites="randomForest">(<code>randomForest</code> package, <a href="#ref-randomForest" role="doc-biblioref">Liaw and Wiener 2002</a>)</span> to model white spruce range changes as a function of the four bioclimatic variables.</p>
<p>All steps from sourcing and formatting the data, to evaluating and plotting model results, are integrated in the workflow as a sequence of sourced scripts. This method was chosen as it is likely closer to the way most of us learn of to use <code>R</code>. However, other approaches could also be used, for instance:</p>
<ul>
<li><p>converting existing scripts to single or multiple functions called from the controller script (see <a href="#running-the-workflow">Running the workflow</a>);</p></li>
<li><p>adapting scripts to <code>SpaDES</code> <span class="citation" data-cites="chubaty2019">(<a href="#ref-chubaty2019" role="doc-biblioref">Chubaty and McIntire 2019</a>, see the <a href="https://ceresbarros.github.io/SpaDES4Dummies/index.html" role="doc-biblioref">SpaDES4Dummies guide</a>)</span> modules and using <code>SpaDES</code> to execute the workflow;</p></li>
<li><p>using <code>targets</code> <span class="citation" data-cites="brousil2023">(see <a href="#ref-brousil2023" role="doc-biblioref">Brousil et al. 2023</a>)</span> to execute the workflow;</p></li>
<li><p>and more…</p></li>
</ul>
<p>The degree to which a workflow developer will encapsulate code into separate scripts, functions or modules/components of an automated workflow using packages like <code>SpaDES</code>/<code>targets</code>, will to some level depend on individual preference and the end users of the workflow. For many “typical” users of <code>R</code> (at least in ecology) it feels strange or even hard to break up a workflow into different scripts/functions/etc. and some have told me they feel it’s “harder to debug and understand a script if I can’t see it easily”. However, before you decide to leave lots of code in your “main” (or controller) script I urge you to think about:</p>
<ul>
<li><p><em>Why</em> are you leaving the code there? Is it absolutely essential to understand that piece to execute the workflow or understand the outputs? Or it is something like a data preparation step that is meaningless for interpretation and therefore could be put in the background away?</p></li>
<li><p><em>Who</em> is going to use your script? Only you? If so, you should know all the pieces and can keep the controller script neat and tidy for production runs. Or do you have teaching in mind and therefore want a longer script that could be easier for “R newbies” – for instance, in the workflow below I left the package installation steps in the controller script because I wanted to make sure you saw them. If your end-user is someone like a stakeholder, they may also not care as much about the workflow details as you do, and a simpler, cleaner script may be easier to run and be last prone to error (e.g.&nbsp;forgetting to run a line).</p></li>
<li><p>If your problem is debugging, please see <a href="#debugging">Debugging</a> for tips that will make your life easier and potentially remove the necessity of very long scripts containing both function definitions and function calls.</p></li>
</ul>
</section>
<section id="step-by-step" class="level2">
<h2 class="anchored" data-anchor-id="step-by-step">Step by step</h2>
<section id="project-structure-and-dependencies" class="level3">
<h3 class="anchored" data-anchor-id="project-structure-and-dependencies">Project structure and dependencies</h3>
<p>A workflow should start with the initial set-up necessary to execute all operations. In <code>R</code> this mostly concerns the <code>R</code> version, setting up project directories and package installation and loading. Other examples are <code>options()</code> (set afterwards in this workflow – <a href="#functions-options-and-study-area">Functions, options and study area</a>) or any necessary system variables (not used here).</p>
<p>Note that in <em>self-contained workflows</em> all packages should be installed at the <em>project level</em> to avoid conflicts with (or changing) the system and/or user <code>R</code> library.</p>
<div class="cell" data-hash="global_cache/html/assertionR_5ba6325bd338917b500eac62bd0ab9e5">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">## an assertion:</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">getRversion</span>() <span class="sc">&lt;</span> <span class="st">"4.3"</span>) {</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"This workflow was build using R v4.3.0;"</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>                <span class="st">"it is recommended you update your R version to v4.3.0 or above"</span>))</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="global_cache/html/setupDirs_f633ab3cc5219fedb70c68501bcd3350">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="do">## package installation with Require</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="do">## create project folder structure</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>projPaths <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">"pkgPath"</span> <span class="ot">=</span> <span class="fu">file.path</span>(<span class="st">"packages"</span>, version<span class="sc">$</span>platform,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>                                        <span class="fu">paste0</span>(version<span class="sc">$</span>major, <span class="st">"."</span>, <span class="fu">strsplit</span>(version<span class="sc">$</span>minor, <span class="st">"[.]"</span>)[[<span class="dv">1</span>]][<span class="dv">1</span>])),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"cachePath"</span> <span class="ot">=</span> <span class="st">"cache"</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"codePath"</span> <span class="ot">=</span> <span class="st">"code"</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"dataPath"</span> <span class="ot">=</span> <span class="st">"data"</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"figPath"</span> <span class="ot">=</span> <span class="st">"figures"</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"outputsPath"</span> <span class="ot">=</span> <span class="st">"outputs"</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(projPaths, dir.create, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="do">## set R main library to project library</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="fu">.libPaths</span>(projPaths<span class="sc">$</span>pkgPath)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I use <code>Require</code> to install all necessary packages. <code>Require</code> can install a mix of CRAN and GitHub packages, and accepts specification of minimum package versions (see <code>?Require</code>). For simplicity sake, this example uses the latest versions of each package from CRAN.</p>
<p>Another advantage of using <code>Require</code> is that it can save a “package snapshot” (i.e.&nbsp;the state of an <code>R</code> library at a particular time) and use it at a later date to install packages using the versions (and sources - CRAN or GitHub) specified in the snapshot file. This ensures that the same library state can be recreated in the future or on another machine.</p>
<p>To demonstrate this, and because it is an essential piece of workflow reproducibility, the code below shows both the initial package installation and saving of the snapshot file – commented to avoid unintended package/snapshot updates during subsequent runs – and package installation using the snapshot file.</p>
<p><span style="color: red;">/!\</span> You will need an active internet connection to run (or re-run) the package installation lines <span style="color: red;">/!\</span></p>
<div class="cell" data-hash="global_cache/html/installPkgs_6fc155996c6a41c27d57130303e40b7a">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">## install specific versions of packages</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>installRequire <span class="ot">&lt;-</span> <span class="sc">!</span><span class="st">"Require"</span> <span class="sc">%in%</span> <span class="fu">rownames</span>(<span class="fu">installed.packages</span>())</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>installRequire <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span>installRequire) <span class="fu">packageVersion</span>(<span class="st">"Require"</span>) <span class="sc">&lt;</span> <span class="st">"0.3.0"</span> <span class="cf">else</span> installRequire</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (installRequire) {</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"Require"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Require)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="do">## this may take a while.</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Notes for Windows users: failure occurs often because the OS can "hold" on to folders.</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="do">##    Don't despair. Restart R session, close all other sessions and run the script up to</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="do">##    this point again.</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># loadOut &lt;- Require(c("data.table", "dismo",</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">#                      "ggplot2", "httr", "maps",</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co">#                      "randomForest",</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co">#                      "rasterVis", "reproducible", </span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co">#                      "terra"),</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co">#                    standAlone = TRUE)</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="do">## eventually we would save the library state in a package snapshot file</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>pkgSnapshotFile <span class="ot">&lt;-</span> <span class="fu">file.path</span>(projPaths<span class="sc">$</span>pkgPath, <span class="st">"pkgSnapshot.txt"</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># pkgSnapshot(</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co">#   packageVersionFile = file.path(projPaths$pkgPath, "pkgSnapshot.txt"),</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co">#   libPaths = projPaths$pkgPath, standAlone = TRUE</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="do">## and replace the above Require() call with</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="fu">Require</span>(<span class="at">packageVersionFile =</span> pkgSnapshotFile, </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">standAlone =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">libPaths =</span> projPaths<span class="sc">$</span>pkgPath,</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">upgrade =</span> <span class="cn">FALSE</span>, <span class="at">require =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="fu">Require</span>(<span class="fu">c</span>(<span class="st">"data.table"</span>, <span class="st">"dismo"</span>,</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>          <span class="st">"ggplot2"</span>, <span class="st">"httr"</span>, <span class="st">"maps"</span>,</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>          <span class="st">"randomForest"</span>,</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>          <span class="st">"rasterVis"</span>, <span class="st">"reproducible"</span>,</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>          <span class="st">"terra"</span>),</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">install =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="global_cache/html/installPkgs-GHA_ab6d907117eb40b9243ab9063697a65a">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"Require"</span>, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Require)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Require</span>(<span class="fu">c</span>(<span class="st">"data.table"</span>, <span class="st">"dismo"</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>          <span class="st">"ggplot2"</span>, <span class="st">"httr"</span>, <span class="st">"maps"</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>          <span class="st">"randomForest"</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>          <span class="st">"rasterVis"</span>, <span class="st">"reproducible"</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>          <span class="st">"terra"</span>),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">standAlone =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In some Windows machines the package installation lines above may have to be run multiple times, with <code>R</code> session “refreshes” between them. This is because, Windows often “holds on” to temporary folders created during package installation, preventing <code>R</code> from manipulating these folders and causing installation failures. I’m afraid you’ll simply have to be patient here.</p>
</section>
<section id="running-the-workflow" class="level3">
<h3 class="anchored" data-anchor-id="running-the-workflow">Running the workflow</h3>
<p>The workflow presented here is relatively simple. It has been broken down into a series of <code>.R</code> scripts sourced in sequence. In the past, I found this to be the most intuitive way of learning how to shift from my spaghetti code into something structured and more robust. However, there are many other ways in which the workflow could have been set up. For instance, each of the scripts could be turned into a function and the functions called here; or packages like <code>SpaDES</code> and <code>targets</code> could be used to set and manage the workflow (see <a href="#the-workflow-at-a-glance">The workflow at a glance</a>). The choice will depend on project complexity and on the level of programming proficiency of the developer, among other factors.</p>
<div class="cell" data-hash="global_cache/html/workflow_75eb069423b008eb000b31408000d1d0">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">## workflow functions/options and study area </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(projPaths<span class="sc">$</span>codePath, <span class="st">"miscFuns.R"</span>))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(projPaths<span class="sc">$</span>codePath, <span class="st">"setup.R"</span>))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="do">## download data</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(projPaths<span class="sc">$</span>codePath, <span class="st">"climateData.R"</span>))</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(projPaths<span class="sc">$</span>codePath, <span class="st">"speciesData.R"</span>))</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="do">## fit SDM</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(projPaths<span class="sc">$</span>codePath, <span class="st">"fitSDM.R"</span>))</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="do">## obtain projections</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(projPaths<span class="sc">$</span>codePath, <span class="st">"projections.R"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="functions-options-and-study-area" class="level4">
<h4 class="anchored" data-anchor-id="functions-options-and-study-area">Functions, options and study area</h4>
<p>The first script, <code>miscFuns.R</code>, contains several functions used across other scripts. It is good practice to <strong>document functions</strong> – what they do, what parameters they expect, and what packages they depend on. As in many <code>R</code> packages, I use the <code>roxygen2</code> format, where function documentation is preceded by <code>#'</code> and documentation fields are noted by a <code>@</code>. Please see this <a href="https://cran.r-project.org/web/packages/roxygen2/vignettes/roxygen2.html">quickstart guide to <code>roxygen2</code></a> to learn more.</p>
<p>Here’s an example taken from one of the functions in <code>miscFuns.R</code>:</p>
<div class="cell" data-hash="global_cache/html/roxygen-example_21e68d72fa2ac263067f117f76b9af17">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Plot a `SpatRaster` as a `ggplot`</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param ras a SpatRaster layer</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param title character. Plot title</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param xlab character. X-axis title</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param ylab character. Y-axis title</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param isDiscrete logical. Should raster data be treated as discrete</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">#'   or continuous for plotting? If `TRUE` plots will be accompanied with</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">#'   a colour legend and only existing values. Otherwise, a continuous</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">#'   colourbar is shown (default).</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return a `ggplot`.</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom rasterVis gplot</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom ggplot2 geom_tile scale_fill_brewer coord_equal theme_bw</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>plotSpatRaster <span class="ot">&lt;-</span> <span class="cf">function</span>(ras, <span class="at">plotTitle =</span> <span class="st">""</span>, <span class="at">xlab =</span> <span class="st">"x"</span>, <span class="at">ylab =</span> <span class="st">"y"</span>, <span class="at">isDiscrete =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The second script of the workflow, <code>setup.R</code>, prepares the study area and sets some global <code>options()</code>. Notice that at the end of this (and other) script(s) I remove objects that are no longer necessary. Although this workflow will not demand a lot of memory, it is good practice to avoid spending memory resources on useless objects and cluttering the environment where the workflow is running – in this case the <code>.GlobalEnv</code>.</p>
</section>
<section id="data-sourcing-and-preparation" class="level4">
<h4 class="anchored" data-anchor-id="data-sourcing-and-preparation">Data sourcing and preparation</h4>
<p>The second and third scripts, <code>climateData.R</code> and <code>speciesData.R</code>, source and prepare bioclimatic data layers and the white spruce percent cover layer (later converted to presence/absence values) necessary to fit the species distribution model (SDM) and to project changes in species distributions. To ensure that the workflow is reproducible and transparent, I have used FAIR data <span class="citation" data-cites="wilkinson2016">(<a href="#ref-wilkinson2016" role="doc-biblioref">Wilkinson et al. 2016</a>)</span> <em>explicitly</em> linked to the workflow and prepared on-the-fly by the <code>prepInputs</code> function (<code>reproducible</code> package).</p>
<p><code>prepInputs</code> downloads the data from the specified URL and when the data is a spatial layer it can crop it and re-project it to match another spatial layer (the <code>studyAreaRas</code> created in <code>setup.R</code>). It will only download the data once and uses <em>internal caching</em> to speed up subsequent runs with the same inputs (e.g.&nbsp;same input data layer and study area). You will also note that I have used outer <code>Cache</code> calls (also from the <code>reproducible</code> package) for further speed up subsequent workflow runs (see <a href="#caching">Caching</a>).</p>
<p>These data preparation scripts save plots of the final climate and species distribution data layers.</p>
</section>
<section id="analytical-steps---model-fitting-validation-and-projections" class="level4">
<h4 class="anchored" data-anchor-id="analytical-steps---model-fitting-validation-and-projections">Analytical steps - model fitting, validation and projections</h4>
<p>The scripts <code>fitSDM.R</code> and <code>projections.R</code> fit, validate and use a random forest (RF) model that relates baseline (from 2011) white spruce presences and absences (derived from the input percent cover raster layer) to the four bioclimatic variables. The model is fit on 80% of the data and tested on the remaining 20% – note the use of <code>set.seed()</code> to ensure that the data partitioning is repeatable.</p>
<p>I used tools from the <code>dismo</code> package to create the training and testing data partitions, to evaluate the model and to predict changes in white spruce distributions under projected climate conditions for 2030, 2050, 2070 and 2090. I also used <code>Cache</code> again to avoid refitting and re-evaluating the model if inputs are not changed.</p>
</section>
<section id="outputs" class="level4">
<h4 class="anchored" data-anchor-id="outputs">Outputs</h4>
<p>The workflow’s outputs are the RF model object, its evaluation results and plots of the raster layer projections. Instead of creating a separate script to save outputs to disk, I have embedded these operations within each script. I prefer saving outputs as they are being created, but in this case this is more a matter of personal taste. In very long workflows, however, it is advisable to save outputs <em>as they are created</em> to avoid losing work should there be a failure preventing workflow completion. See additional notes on <a href="#saving">Saving</a>.</p>
<div class="cell" data-layout-align="center" data-hash="global_cache/html/fig-baselineproj_a4c8796e4573fa58459b68ea11b9f841">
<div class="cell-output-display">
<div id="fig-baselineproj" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="figures/SDMprojections_baseline.png" class="img-fluid figure-img" style="width:50.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;1: Random forest projections of white spruce distributions in BC, Canada, under baseline conditions of four bioclimatic variables (annual mean temperature and annual precipitation, temperature and precipitation seasonality.</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center" data-hash="global_cache/html/fig-futureproj_6dbbb7a14d4a0084b0524d91b9b1ca13">
<div class="cell-output-display">
<div id="fig-futureproj" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="figures/SDMprojections_future.png" class="img-fluid figure-img" style="width:70.0%"></p>
<figcaption class="figure-caption">Figure&nbsp;2: Random forest projections of white spruce distributions in BC, Canada, for future values of the same four bioclimatic variables – only one GCM and one emissions scenario were used.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="and-voilà" class="level4">
<h4 class="anchored" data-anchor-id="and-voilà">And voilà!</h4>
<p>That’s it!</p>
<p>I now invite you to make further changes to the workflow. Some ideas are to make it so that you can control certain inputs (e.g.&nbsp;climate scenarios and periods) from the controller script, or turning the existing scripts into functions, or even using other workflow structures and packages like <code>SpaDES</code> and <code>targets</code>, which are beyond the scope of this example <span class="citation" data-cites="brousil2023">(but see&nbsp;<a href="https://ceresbarros.github.io/SpaDES4Dummies/index.html" role="doc-biblioref">SpaDES4Dummies guide</a> and <a href="#ref-brousil2023" role="doc-biblioref">Brousil et al. 2023</a>)</span>.</p>
<p>I hope this minimal example has given useful tools and ideas that will help you create <span class="math inline">R^3</span>T workflows and enhance your existing work with these principles.</p>
</section>
</section>
</section>
<section id="a-note-on" class="level2">
<h2 class="anchored" data-anchor-id="a-note-on">A note on…</h2>
<section id="debugging" class="level3">
<h3 class="anchored" data-anchor-id="debugging">Debugging</h3>
<p>How many of you have created the arguments of a “problematic” function as objects on your <code>.GlobalEnv</code> to then execute a copy-pasted version of the said function line by line? If I had to guess I’d say too many! And I was doing that too – because there are too many <code>R</code> things we don’t learn on that stats. course in uni! But there are FAR better ways of debugging in <code>R</code>. Two common ones are to:</p>
<p>1. place a <code>browser()</code> call on your “problematic” function</p>
<div class="cell" data-hash="global_cache/html/browser-example_e5f68e127ed4d45387487c67270e1eee">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>plotSpatRaster <span class="ot">&lt;-</span> <span class="cf">function</span>(ras, <span class="at">plotTitle =</span> <span class="st">""</span>, <span class="at">xlab =</span> <span class="st">"x"</span>, <span class="at">ylab =</span> <span class="st">"y"</span>, <span class="at">isDiscrete =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  plotOut <span class="ot">&lt;-</span> <span class="fu">gplot</span>(ras) <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> value))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  plotOut <span class="ot">&lt;-</span> <span class="cf">if</span> (isDiscrete) {</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    vals <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(<span class="fu">unique</span>(<span class="fu">as.vector</span>(ras[])))</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    plotOut <span class="sc">+</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"Blues"</span>, <span class="at">direction =</span> <span class="dv">1</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                           <span class="at">na.value =</span> <span class="st">"grey90"</span>, <span class="at">guide =</span> <span class="st">"legend"</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">breaks =</span> vals, <span class="at">limits =</span> vals)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    plotOut <span class="sc">+</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_distiller</span>(<span class="at">palette =</span> <span class="st">"Blues"</span>, <span class="at">direction =</span> <span class="dv">1</span>, <span class="at">na.value =</span> <span class="st">"grey90"</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">browser</span>() <span class="do">## debugging mode will start here, once the function is executed</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  plotOut <span class="sc">+</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_equal</span>() <span class="sc">+</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> plotTitle, <span class="at">x =</span> xlab, <span class="at">y =</span> ylab, <span class="at">fill =</span> <span class="st">""</span>)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>2. to use <code>debug(&lt;function_name&gt;)</code> and <code>debugOnce(&lt;function_name&gt;)</code> to execute the function in debugging mode (like putting a <code>browser()</code> call right at the start of the function):</p>
<div class="cell" data-hash="global_cache/html/debugonce_492fade96daea6153915fbd91b92bf27">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">debugOnce</span>(plotSpatRaster)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSpatRaster</span>(ras)  <span class="do">## the entire function will executed in debuging mode, only once</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="fu">debug</span>(plotSpatRaster)  <span class="do">## always execute in debugging mode</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSpatRaster</span>(ras)  </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="fu">undebug</span>(plotSpatRaster)  <span class="do">## stop debugging</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>These two functions will enable you to “enter” the function environment as it’s being executed and have access to the objects/arguments that the function “sees”, making debugging SO much easier.</p>
</section>
<section id="caching" class="level3">
<h3 class="anchored" data-anchor-id="caching">Caching</h3>
<p>Caching has been my life saviour for many years now. When you do a lot of coding and your code takes a while to run, debugging and development can become very slow (and frustrating) if you need to wait many minutes (many times) to get to the point of interest in the code. To avoid this, many of us are actually doing “manual” caching – we are saving intermediate objects to disk, checking whether they exist and when they do, bypassing re-running computations and loading them into <code>R</code>.</p>
<p>The problem is that this is not a robust solution – it is not sufficient to check whether the outputs exist – and others (i.e.&nbsp;computer programmers) have had more elegant solutions for a while. <code>Cache</code> (<code>reproducible</code> package) makes these elegant solutions easy to use by non-computer-scientists. On the first run of a function call, <code>Cache</code> will save its outputs and sufficient information about the function’s inputs and code. When the function call is run a second time, <code>Cache</code> will first check whether the outputs have been cached (i.e.&nbsp;saved), and whether the inputs and code have changed, and load the saved outputs if they haven’t.</p>
<p>As with most solutions, there are always trade-offs to consider. The first is a <em>time trade-off</em>. If the call being cached is very fast to run, the extra time used for caching, checking and loading will probably not compensate. One thing to consider is to not cache very large <em>inputs</em> (i.e.&nbsp;the objects passed to arguments) of a function (see <code>omitArgs</code> argument of <code>Cache</code>), as they will take longer to digest. Instead pass a smaller object that is unique to the large object to the <code>cacheExtra</code> argument.</p>
<div class="cell" data-hash="global_cache/html/badcache_a4be31360a5d5cb9402d8c8036093a82">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">Cache</span>(runif, <span class="at">n =</span> <span class="dv">10</span>))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">runif</span>(<span class="at">n =</span> <span class="dv">10</span>)) <span class="do">## will always be faster</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The second is <em>disk space</em>. If you have very limited disk space, it may not be a good idea to cache several large intermediate files, as your disk may be filled up quickly, especially when working across many projects. Solutions are to only cache the slowest steps or to turn caching off (see <code>useCache</code> argument of <code>Cache</code>) in situations when you know disk spade will be limited (e.g.&nbsp;sharing your code with someone working with a small disk).</p>
</section>
<section id="saving" class="level3">
<h3 class="anchored" data-anchor-id="saving">Saving</h3>
<p>As a rule of thumb, I avoid saving multiple objects in a single file (e.g.&nbsp;an <code>.RData</code> or <code>.rda</code> file), as it can reduce workflow robustness – if that file becomes corrupted several pieces or outputs of the workflow may be lost. Instead, I recommend saving/loading single objects as <code>.rds</code> or <code>.qs</code> (from <code>qs</code> package) files (see <code>?saveRDS</code> and <code>?readRDS</code> and <code>?qs::qsave</code> and <code>?qs::qread</code>). <code>Cache</code> will, by default, use the <code>.rds</code> format, but it is possible to opt for the <code>.qs</code> format by setting <code>options("reproducible.cacheSaveFormat" = "qs")</code>. The advantages of using <code>.qs</code> are a higher compression rate and faster read/write speeds, the disadvantage is that your workflow will depend on an extra package.</p>
</section>
</section>
<section id="acknowledgements" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgements">Acknowledgements</h2>
<p>I would like to acknowledge all participants (guinea-pigs, *ahem*) of the ‘Coding SOS: Reproducible workflows, GitHub, and R Open Mic’ workshop of the 2023 BES Macroecology SIG meeting, Birmingham UK, who through their curiosity and thoughtful questions have helped improve the contents of this example workflow.</p>
</section>
<section id="references" class="level2 unnumbered">


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-beaudoin2014" class="csl-entry" role="listitem">
Beaudoin, A., P. Y. Bernier, L. Guindon, P. Villemaire, X. J. Guo, G. Stinson, T. Bergeron, S. Magnussen, and R. J. Hall. 2014. <span>“Mapping Attributes of Canada<span>’</span>s Forests at Moderate Resolution Through <span><em>k</em></span> NN and MODIS Imagery.”</span> <em>Canadian Journal of Forest Research</em> 44 (5): 521–32. <a href="https://doi.org/10.1139/cjfr-2013-0401">https://doi.org/10.1139/cjfr-2013-0401</a>.
</div>
<div id="ref-brousil2023" class="csl-entry" role="listitem">
Brousil, Matthew R., Alessandro Filazzola, Michael F. Meyer, Sapna Sharma, and Stephanie E. Hampton. 2023. <span>“Improving Ecological Data Science with Workflow Management Software.”</span> <em>Methods in Ecology and Evolution</em> 14 (6): 1381–88. <a href="https://doi.org/10.1111/2041-210X.14113">https://doi.org/10.1111/2041-210X.14113</a>.
</div>
<div id="ref-chubaty2019" class="csl-entry" role="listitem">
Chubaty, Alex M., and Eliot J. B. McIntire. 2019. <em>SpaDES: Develop and Run Spatially Explicit Discrete Event Simulation Models</em>. <a href="https:// CRAN.R-project.org/package=SpaDES">https:// CRAN.R-project.org/package=SpaDES</a>.
</div>
<div id="ref-fick2017" class="csl-entry" role="listitem">
Fick, Stephen E., and Robert J. Hijmans. 2017. <span>“WorldClim 2: New 1<span>-</span>Km Spatial Resolution Climate Surfaces for Global Land Areas.”</span> <em>International Journal of Climatology</em> 37 (12): 4302–15. <a href="https://doi.org/10.1002/joc.5086">https://doi.org/10.1002/joc.5086</a>.
</div>
<div id="ref-randomForest" class="csl-entry" role="listitem">
Liaw, Andy, and Matthew Wiener. 2002. <span>“Classification and Regression by randomForest”</span> 2: 18–22. <a href="https://CRAN.R-project.org/doc/Rnews/">https://CRAN.R-project.org/doc/Rnews/</a>.
</div>
<div id="ref-Require" class="csl-entry" role="listitem">
McIntire, Eliot J B. 2023. <span>“Require: Installing and Loading r Packages for Reproducible Workflows.”</span> <a href="https://CRAN.R-project.org/package=Require">https://CRAN.R-project.org/package=Require</a>.
</div>
<div id="ref-reproducible" class="csl-entry" role="listitem">
McIntire, Eliot J B, and Alex M Chubaty. 2023. <span>“<span></span>Reproducible<span></span>: Enhance Reproduciblity of r Code.”</span> <a href="https://reproducible.predictiveecology.org">https://reproducible.predictiveecology.org</a>.
</div>
<div id="ref-wilkinson2016" class="csl-entry" role="listitem">
Wilkinson, Mark D., Michel Dumontier, IJsbrand Jan Aalbersberg, Gabrielle Appleton, Myles Axton, Arie Baak, Niklas Blomberg, et al. 2016. <span>“The FAIR Guiding Principles for Scientific Data Management and Stewardship.”</span> <em>Scientific Data</em> 3 (1): 160018. <a href="https://doi.org/10.1038/sdata.2016.18">https://doi.org/10.1038/sdata.2016.18</a>.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



<script src="global_files/libs/quarto-html/zenscroll-min.js"></script>
</body></html>